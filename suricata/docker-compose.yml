services:
  suricata:
    build: .
    container_name: suricata-nids
    network_mode: host
    restart: unless-stopped

    cap_add:
      - NET_ADMIN
      - NET_RAW

    volumes:
      - ./config/suricata.yaml:/etc/suricata/suricata.yaml.tpl:ro
      - ./config/rules:/etc/suricata/rules:rw
      - suricata-logs:/var/log/suricata:rw

    environment:
      SURICATA_INTERFACE: eth0
      HOME_NET: 192.168.1.0/24
      UPDATE_RULES: "true"
      SURICATA_OPTIONS: "-v"

    healthcheck:
      test: ["CMD-SHELL", "suricata -T -c /etc/suricata/suricata.yaml >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.10.0
    depends_on:
      suricata:
        condition: service_healthy
    volumes:
      - ./config/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - suricata-logs:/var/log/suricata:ro
    command: filebeat -e -strict.perms=false

volumes:
  suricata-logs:
